<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Formulario C√≥smico</title>
  <style>
    body {
      background-color: #F8F5FC;
      font-family: 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 30px;
      color: #4a4a4a;
    }

    h2 {
      text-align: center;
      color: #A38CC6;
    }

    .logo {
      display: block;
      margin: auto;
      width: 120px;
      border-radius: 50%;
    }

    label {
      display: block;
      margin-top: 12px;
      color: #6B4F8A;
      font-weight: bold;
    }

    input,
    button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      background-color: #C9B9E5;
      border: none;
      font-weight: bold;
      margin-top: 20px;
    }

    .info {
      font-size: 0.9em;
      color: #888;
    }

    .warning {
      color: red;
      font-size: 0.9em;
    }

    .checkbox-wrapper {
      margin-top: 20px;
      display: flex;
      align-items: center;
    }

    .checkbox-wrapper input {
      width: auto;
      margin-right: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
    }

    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      overflow-y: scroll;
      max-height: 80%;
    }

    .close {
      float: right;
      font-size: 18px;
      cursor: pointer;
      color: #888;
    }

    .suggestions {
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 150px;
      overflow-y: auto;
      background: white;
      position: absolute;
      width: calc(100% - 22px);
      z-index: 1000;
      display: none;
    }

    .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
      background-color: #f5f5f5;
    }

    .city-container {
      position: relative;
    }

    .manual-entry {
      background-color: #e8f4f8;
      font-style: italic;
    }
  .checkbox-item input { margin-right: 10px; width: auto; }
  .extra-input { display: none; margin-top: 8px; }

  </style>
</head>

<body>
  <img src="https://amjskrqaoiuabscecmji.supabase.co/storage/v1/object/public/logos/isologo-CC_arcoiris.png"
    class="logo" alt="Logo">
  <h2>SOLICITUD CARNET C√ìSMICO</h2>
  <p class="info">üåü Escribe el nombre de tu ciudad y selecciona una opci√≥n de la lista de sugerencias.
  </p>

  <form id="cosmicForm">

    <label>Nombre:</label><input type="text" name="nombre" required>
    <label>Apellido:</label><input type="text" name="apellido" required>
    <label>Nombre que te gustar√≠a figure en el carnet:</label><input type="text" name="nombrecc" required>
    <label>Fecha de nacimiento:</label><input type="date" name="fecha_nac" required>
    <label>Hora de nacimiento:</label><input type="time" name="hora_nac" required>

    <label>Ciudad de nacimiento:</label>
    <div class="city-container">
      <input id="ciudad" name="ciudad" type="text" autocomplete="off" required>
      <div id="suggestions-ciudad" class="suggestions"></div>
    </div>
    <div id="warning-ciudad" class="warning"></div>
    <label>Provincia:</label>
    <input id="provincia" name="provincia" type="text">
    <label>Pa√≠s:</label>
    <input id="pais" name="pais" type="text">

    <label>Ciudad de residencia:</label>
    <div class="city-container">
      <input id="ciudad_resi" name="ciudad_resi" type="text" autocomplete="off" required>
      <div id="suggestions-resi" class="suggestions"></div>
    </div>
    <div id="warning-resi" class="warning"></div>
    <label>Provincia de residencia:</label>
    <input id="provincia_resi" name="provincia_resi" type="text">
    <label>Pa√≠s de residencia:</label>
    <input id="pais_resi" name="pais_resi" type="text">

    <label>Email:</label><input type="email" name="email" required>
    <label>Tel√©fono:</label><input type="tel" name="telefono">
     <!-- Foto -->
    <label>Foto (JPG/PNG, m√°x. 700KB):</label>
    <input type="file" id="foto" name="foto" accept="image/png, image/jpeg">
    
    <!-- pregunta 3D --->
    <label>¬øQu√© talento, oficio o profesi√≥n tienes para ofrecer?:</label><input type="text" name="talento">
    <!-- Campos ocultos para coordenadas -->
    <input type="hidden" id="lat" name="lat">
    <input type="hidden" id="lon" name="lon">
    <input type="hidden" id="lat_resi" name="lat_resi">
    <input type="hidden" id="lon_resi" name="lon_resi">

  <!-- Acceso -->
    <label>Acced√≠ a esta encuesta por:</label>
    <select id="acceso" name="acceso" required>
      <option value="">Selecciona...</option>
      <option value="Instagram">Instagram</option>
      <option value="WhatsApp">WhatsApp</option>
      <option value="Nueva Humanidad">Nueva Humanidad</option>
      <option value="Colaborador CC">Colaborador CC</option>
  </select>
  <input type="text" id="nombreColaborador" class="extra-input" placeholder="Nombre del colaborador">
    
    <div class="checkbox-wrapper">
      <input type="checkbox" id="politica" required>
      <label for="politica">Declaro haber le√≠do y aceptado la <a href="#" onclick="mostrarModal()">Pol√≠tica de
          Privacidad</a>.</label>
    </div>
    <button type="submit" id="btnEnviar">Enviar</button>
 
  </form>

  <p id="mensaje-error" style="color:red; display:none; font-weight:bold; text-align:center;">
    Ya has completado el formulario anteriormente üí´ ¬°Gracias por ser parte!
  </p>

  <p id="mensaje-exito" style="color:green; display:none; font-weight:bold; text-align:center;">
    ¬°Formulario enviado con √©xito! El Equipo CC festeja tu llegada üåà
  </p>



  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h3>Pol√≠tica de Privacidad</h3>
      <p>
        AVISO DE PRIVACIDAD Y TRATAMIENTO DE DATOS PERSONALES</br>

        Responsable del tratamiento:</br>
        Proyecto Carnet C√≥smico ‚Äì Registro de Identidad Energ√©tica (RIE)</br>
        Responsables: Romina C√°ceres y √Ångeles Amat</br>

        Contacto: carnetcosmico.oficial@gmail.com</br>

        Al enviar tus datos personales y aceptar pertenecer al registro nueva huella, declar√°s haber le√≠do y aceptado
        esta pol√≠tica de privacidad. Los datos ser√°n tratados conforme a la normativa vigente en materia de protecci√≥n
        de datos personales (Ley 25.326 Argentina, RGPD en caso de usuarios europeos, u otra normativa aplicable).</br>
        Datos que se recopilan</br>
        Los datos personales recopilados incluyen:</br>
        Nombre y apellido</br>
        Fecha de nacimiento</br>
        Hora de nacimiento</br>
        Lugar de nacimiento</br>
        Direcci√≥n de correo electr√≥nico</br>

        Otros datos personales energ√©ticos necesarios para la elaboraci√≥n del Carnet C√≥smico y para el Registro de
        Identidad Energ√©tica (por ej.: tipo de dise√±o humano, kin maya, n√∫mero de destino, √°ngel de nacimiento).</br>
        Finalidad del tratamiento</br>
        Los datos ser√°n tratados √∫nicamente con los siguientes fines:</br>
        Elaborar la f√≥rmula energ√©tica individual para el Carnet C√≥smico.</br>
        Registrar dicha f√≥rmula dentro del Registro de Identidad Energ√©tica (RIE) como parte del Censo Energ√©tico
        Colectivo.</br>
        Generar estudios evolutivos y mapas de conciencia colectivos (sin identificaci√≥n personal en las publicaciones
        de resultados).</br>
        Facilitar comunicaciones relacionadas con actividades, talleres, encuentros y novedades del Carnet C√≥smico.</br>
        Ofrecer acceso a espacios de aprendizaje, autoconocimiento y evoluci√≥n personal, tanto individuales como
        colectivos.</br>
        Base legal</br>
        El tratamiento de los datos se realiza sobre la base del consentimiento libre, espec√≠fico, informado e
        inequ√≠voco otorgado por el titular de los datos.</br>
        Conservaci√≥n</br>
        Los datos ser√°n conservados:</br>
        mientras la herramienta Carnet C√≥smico est√© en funcionamiento o hasta que el titular solicite su supresi√≥n.</br>
        Comunicaci√≥n de datos a terceros</br>
        Los datos no ser√°n cedidos a terceros sin consentimiento previo. En caso de necesidad de colaboraci√≥n con
        terceros en el marco de la investigaci√≥n energ√©tica colectiva o desarrollo tecnol√≥gico (por ej.: equipos
        t√©cnicos de IA), se solicitar√° consentimiento espec√≠fico previo.</br>
        Los datos podr√°n ser anonimizados para fines de estudios colectivos (es decir, se usar√° la informaci√≥n
        estad√≠stica sin identificar a la persona).</br>
        Transferencias internacionales</br>
        Actualmente, no se prev√©n transferencias internacionales de datos.
        Si esto se modificara (por ejemplo, en el caso de usar servicios tecnol√≥gicos que impliquen servidores en otros
        pa√≠ses), se garantizar√° el cumplimiento de las normativas aplicables mediante las cl√°usulas y garant√≠as
        correspondientes.</br>

        Derechos del titular</br>
        Como titular de los datos, ten√©s derecho a:</br>
        ‚úÖ Acceder a tus datos personales.</br>
        ‚úÖ Solicitar su rectificaci√≥n o actualizaci√≥n.</br>
        ‚úÖ Solicitar su supresi√≥n.</br>
        ‚úÖ Oponerte al tratamiento.</br>
        ‚úÖ Solicitar la limitaci√≥n del tratamiento.</br>
        ‚úÖ Solicitar la portabilidad de tus datos.</br>
        Pod√©s ejercer estos derechos escribiendo a: carnetcosmico@gmail.com
        Responderemos tu solicitud en el plazo legalmente establecido.</br>

        Medidas de seguridad</br>
        Se han implementado medidas t√©cnicas y organizativas adecuadas para garantizar la confidencialidad, integridad y
        seguridad de los datos personales y evitar su alteraci√≥n, p√©rdida, acceso no autorizado o uso indebido.</br>

        Notas adicionales importantes:</br>
        El hecho de aceptar pertenecer al registro nueva huella implica aceptar que tu f√≥rmula energ√©tica ser√°
        incorporada al Censo Energ√©tico Colectivo y podr√° ser utilizada (de forma an√≥nima o colectiva) para los fines de
        mapeo y estudio evolutivo.</br>
        En ning√∫n caso los datos personales ser√°n usados con fines comerciales ni cedidos a terceros sin
        consentimiento.</br>
        La participaci√≥n es voluntaria y revocable en cualquier momento.</br>
      </p>
    </div>
  </div>
  <!-- build: 2025-08-15 17:45 -->
  <script>
    
    function mostrarModal() {
      document.getElementById("modal").style.display = "block";
    }
    function cerrarModal() {
      document.getElementById("modal").style.display = "none";
    }

    // Mostrar input para colaborador
  document.getElementById('acceso').addEventListener('change', function() {
  const val = this.value;
  document.getElementById('nombreColaborador').style.display = (val.includes('Colaborador')) ? 'block' : 'none';
});
    
    // Base de datos expandida con ciudades principales del mundo
    const ciudadesMundo = [
      // Argentina
      {ciudad: "Buenos Aires", provincia: "Ciudad Aut√≥noma de Buenos Aires", pais: "Argentina", lat: -34.6118, lon: -58.3960},
      {ciudad: "C√≥rdoba", provincia: "C√≥rdoba", pais: "Argentina", lat: -31.4201, lon: -64.1888},
      {ciudad: "Rosario", provincia: "Santa Fe", pais: "Argentina", lat: -32.9442, lon: -60.6505},
      {ciudad: "La Plata", provincia: "Buenos Aires", pais: "Argentina", lat: -34.9215, lon: -57.9545},
      {ciudad: "Mar del Plata", provincia: "Buenos Aires", pais: "Argentina", lat: -38.0055, lon: -57.5426},
      {ciudad: "Mendoza", provincia: "Mendoza", pais: "Argentina", lat: -32.8895, lon: -68.8458},
      {ciudad: "Tucum√°n", provincia: "Tucum√°n", pais: "Argentina", lat: -26.8083, lon: -65.2176},
      {ciudad: "Salta", provincia: "Salta", pais: "Argentina", lat: -24.7821, lon: -65.4232},
      {ciudad: "Santa Fe", provincia: "Santa Fe", pais: "Argentina", lat: -31.6333, lon: -60.7000},

      // Espa√±a
      {ciudad: "Madrid", provincia: "Comunidad de Madrid", pais: "Espa√±a", lat: 40.4168, lon: -3.7038},
      {ciudad: "Barcelona", provincia: "Catalu√±a", pais: "Espa√±a", lat: 41.3851, lon: 2.1734},
      {ciudad: "Valencia", provincia: "Comunidad Valenciana", pais: "Espa√±a", lat: 39.4699, lon: -0.3763},
      {ciudad: "Sevilla", provincia: "Andaluc√≠a", pais: "Espa√±a", lat: 37.3891, lon: -5.9845},
      {ciudad: "Zaragoza", provincia: "Arag√≥n", pais: "Espa√±a", lat: 41.6488, lon: -0.8891},
      {ciudad: "M√°laga", provincia: "Andaluc√≠a", pais: "Espa√±a", lat: 36.7213, lon: -4.4214},
      {ciudad: "Murcia", provincia: "Regi√≥n de Murcia", pais: "Espa√±a", lat: 37.9922, lon: -1.1307},
      {ciudad: "Palma", provincia: "Islas Baleares", pais: "Espa√±a", lat: 39.5696, lon: 2.6502},
      {ciudad: "Las Palmas", provincia: "Canarias", pais: "Espa√±a", lat: 28.1248, lon: -15.4300},
      {ciudad: "Bilbao", provincia: "Pa√≠s Vasco", pais: "Espa√±a", lat: 43.2627, lon: -2.9253},

      // Francia
      {ciudad: "Par√≠s", provincia: "√éle-de-France", pais: "Francia", lat: 48.8566, lon: 2.3522},
      {ciudad: "Marsella", provincia: "Provenza-Alpes-Costa Azul", pais: "Francia", lat: 43.2965, lon: 5.3698},
      {ciudad: "Lyon", provincia: "Auvernia-R√≥dano-Alpes", pais: "Francia", lat: 45.7640, lon: 4.8357},
      {ciudad: "Toulouse", provincia: "Occitania", pais: "Francia", lat: 43.6047, lon: 1.4442},
      {ciudad: "Niza", provincia: "Provenza-Alpes-Costa Azul", pais: "Francia", lat: 43.7102, lon: 7.2620},

      // Italia
      {ciudad: "Roma", provincia: "Lacio", pais: "Italia", lat: 41.9028, lon: 12.4964},
      {ciudad: "Mil√°n", provincia: "Lombard√≠a", pais: "Italia", lat: 45.4642, lon: 9.1900},
      {ciudad: "N√°poles", provincia: "Campania", pais: "Italia", lat: 40.8518, lon: 14.2681},
      {ciudad: "Tur√≠n", provincia: "Piamonte", pais: "Italia", lat: 45.0703, lon: 7.6869},
      {ciudad: "Palermo", provincia: "Sicilia", pais: "Italia", lat: 38.1157, lon: 13.3615},

      // Reino Unido
      {ciudad: "Londres", provincia: "Inglaterra", pais: "Reino Unido", lat: 51.5074, lon: -0.1278},
      {ciudad: "Birmingham", provincia: "Inglaterra", pais: "Reino Unido", lat: 52.4862, lon: -1.8904},
      {ciudad: "Manchester", provincia: "Inglaterra", pais: "Reino Unido", lat: 53.4808, lon: -2.2426},
      {ciudad: "Glasgow", provincia: "Escocia", pais: "Reino Unido", lat: 55.8642, lon: -4.2518},
      {ciudad: "Liverpool", provincia: "Inglaterra", pais: "Reino Unido", lat: 53.4084, lon: -2.9916},

      // Alemania
      {ciudad: "Berl√≠n", provincia: "Berl√≠n", pais: "Alemania", lat: 52.5200, lon: 13.4050},
      {ciudad: "Hamburgo", provincia: "Hamburgo", pais: "Alemania", lat: 53.5511, lon: 9.9937},
      {ciudad: "M√∫nich", provincia: "Baviera", pais: "Alemania", lat: 48.1351, lon: 11.5820},
      {ciudad: "Colonia", provincia: "Renania del Norte-Westfalia", pais: "Alemania", lat: 50.9375, lon: 6.9603},
      {ciudad: "Frankfurt", provincia: "Hesse", pais: "Alemania", lat: 50.1109, lon: 8.6821},

      // Australia
      {ciudad: "S√≠dney", provincia: "Nueva Gales del Sur", pais: "Australia", lat: -33.8688, lon: 151.2093},
      {ciudad: "Melbourne", provincia: "Victoria", pais: "Australia", lat: -37.8136, lon: 144.9631},
      {ciudad: "Brisbane", provincia: "Queensland", pais: "Australia", lat: -27.4698, lon: 153.0251},
      {ciudad: "Perth", provincia: "Australia Occidental", pais: "Australia", lat: -31.9505, lon: 115.8605},
      {ciudad: "Adelaida", provincia: "Australia Meridional", pais: "Australia", lat: -34.9285, lon: 138.6007},

      // Otros pa√≠ses latinoamericanos
      {ciudad: "S√£o Paulo", provincia: "S√£o Paulo", pais: "Brasil", lat: -23.5505, lon: -46.6333},
      {ciudad: "Rio de Janeiro", provincia: "Rio de Janeiro", pais: "Brasil", lat: -22.9068, lon: -43.1729},
      {ciudad: "Bras√≠lia", provincia: "Distrito Federal", pais: "Brasil", lat: -15.8267, lon: -47.9218},
      {ciudad: "Santiago", provincia: "Regi√≥n Metropolitana", pais: "Chile", lat: -33.4489, lon: -70.6693},
      {ciudad: "Lima", provincia: "Lima", pais: "Per√∫", lat: -12.0464, lon: -77.0428},
      {ciudad: "Bogot√°", provincia: "Cundinamarca", pais: "Colombia", lat: 4.7110, lon: -74.0721},
      {ciudad: "Ciudad de M√©xico", provincia: "Ciudad de M√©xico", pais: "M√©xico", lat: 19.4326, lon: -99.1332},
      {ciudad: "Caracas", provincia: "Distrito Capital", pais: "Venezuela", lat: 10.4806, lon: -66.9036},
      {ciudad: "Quito", provincia: "Pichincha", pais: "Ecuador", lat: -0.1807, lon: -78.4678},
      {ciudad: "La Paz", provincia: "La Paz", pais: "Bolivia", lat: -16.5000, lon: -68.1193},
      {ciudad: "Asunci√≥n", provincia: "Asunci√≥n", pais: "Paraguay", lat: -25.2637, lon: -57.5759},
      {ciudad: "Montevideo", provincia: "Montevideo", pais: "Uruguay", lat: -34.9011, lon: -56.1645}
    ];

    function cleanCityName(name) {
      return name.replace(/^(Municipio de |Municipality of |Province of |Provincia de )/i, '').trim();
    }

    function cleanProvinceName(name) {
      return name.replace(/( Province| provincia)$/i, '').trim();
    }

    function getCountryName(countryCode) {
      const countries = {
        'AR': 'Argentina', 'BR': 'Brasil', 'CL': 'Chile', 'UY': 'Uruguay', 'PY': 'Paraguay',
        'PE': 'Per√∫', 'BO': 'Bolivia', 'VE': 'Venezuela', 'CO': 'Colombia', 'EC': 'Ecuador',
        'MX': 'M√©xico', 'ES': 'Espa√±a', 'FR': 'Francia', 'IT': 'Italia', 'DE': 'Alemania',
        'GB': 'Reino Unido', 'AU': 'Australia', 'US': 'Estados Unidos', 'CA': 'Canad√°', 'AD': 'Andorra'
      };
      return countries[countryCode] || countryCode;
    }

    function setupCityAutocomplete(inputId, suggestionsId, provId, paisId, latId, lonId, warnId) {
      const input = document.getElementById(inputId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      let selectedFromList = false;

      function showSuggestions(cities) {
        suggestionsDiv.innerHTML = '';

        cities.forEach(city => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = `${city.ciudad}, ${city.provincia}, ${city.pais}`;
          item.onmousedown = (e) => {
            e.preventDefault();
            selectCity(city);
          };
          suggestionsDiv.appendChild(item);
        });

        suggestionsDiv.style.display = cities.length > 0 ? 'block' : 'none';
      }

      function selectCity(city) {
        input.value = cleanCityName(city.ciudad);
        const provInput = document.getElementById(provId);
        const paisInput = document.getElementById(paisId);
        const latInput = document.getElementById(latId);
        const lonInput = document.getElementById(lonId);
        const warnElement = document.getElementById(warnId);

        if (provInput) provInput.value = cleanProvinceName(city.provincia);
        if (paisInput) paisInput.value = city.pais;
        if (latInput) latInput.value = city.lat;
        if (lonInput) lonInput.value = city.lon;
        if (warnElement) warnElement.innerText = '';

        suggestionsDiv.style.display = 'none';
        selectedFromList = true;
      }

      function normalizeString(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
      }

      function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

      //// ---> cabio y agrego ms de control de teclas

      input.addEventListener('input', debounce(function () {
       const query = this.value.trim();
       const warning = document.getElementById(warnId);
       selectedFromList = false;

      if (query.length < 2) {
        suggestionsDiv.style.display = 'none';
      if (warning) warning.innerText = '';
      return;
    }

     const normalizedQuery = normalizeString(query);

     const localResults = ciudadesMundo.filter(city =>
       normalizeString(city.ciudad).includes(normalizedQuery) ||
       normalizeString(city.provincia).includes(normalizedQuery)
     ).slice(0, 8);

     const hasResults = localResults.length > 0;
     showSuggestions(localResults);

     if (!hasResults) {
       fetchFromAPI(query).then(apiResults => {
         const combinedResults = [...localResults, ...apiResults]
           .filter((city, index, self) =>
           index === self.findIndex(c => c.ciudad === city.ciudad && c.provincia === city.provincia)
           )
           .slice(0, 8);

         showSuggestions(combinedResults);
       }).catch(() => {
         showSuggestions(localResults);
       });
     }
   }, 500)); // <-- 500ms de espera despu√©s de dejar de tipear


         //////
//let openWeatherEnabled = true; // Para deshabilitar fallback si la key falla

async function fetchFromAPI(query) {
  const locationIQKey = "pk.20ec11479404d168aa15199605e1bb64"; // LocationIQ
  const openWeatherKey = "5&appid=bd5e378503939ddaee76f12ad7a97608"; // OpenWeather (opcional)

  // --- 1. Intentar con LocationIQ (con timeout) ---
  try {
    const locationIQPromise = fetch(`https://us1.locationiq.com/v1/search.php?key=${locationIQKey}&q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=5`);
    const res = await Promise.race([
      locationIQPromise,
      new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout LocationIQ")), 4000))
    ]);

    if (res.ok) {
      const data = await res.json();
      if (data.length > 0) {
        return data.map(place => ({
          ciudad: cleanCityName(place.address?.city || place.address?.town || place.display_name.split(',')[0]),
          provincia: cleanProvinceName(place.address?.state || ''),
          pais: place.address?.country || '',
          lat: place.lat,
          lon: place.lon
        }));
      }
    }
  } catch (e) {
    console.warn("LocationIQ fall√≥:", e.message);
  }

  // --- 2. Intentar con OpenWeather solo si est√° habilitado ---
  if (openWeatherEnabled && openWeatherKey) {
    try {
      const res = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(query)}&limit=5&appid=${openWeatherKey}`);
      if (res.status === 401) {
        console.error("OpenWeather deshabilitado por error 401 (API Key inv√°lida)");
        openWeatherEnabled = false; // Deshabilitar futuros intentos
        return [];
      }

      if (res.ok) {
        const data = await res.json();
        if (data.length > 0) {
          return data.map(place => ({
            ciudad: cleanCityName(place.name),
            provincia: cleanProvinceName(place.state || ''),
            pais: getCountryName(place.country),
            lat: place.lat,
            lon: place.lon
          }));
        }
      }
    } catch (e) {
      console.warn("OpenWeather fall√≥:", e.message);
    }
  }

  return []; // Ning√∫n resultado
}




      input.addEventListener('blur', function () {
        setTimeout(() => {
          suggestionsDiv.style.display = 'none';

          if (this.value && !selectedFromList) {
            const warning = document.getElementById(warnId);
            if (warning) warning.innerText = "‚ö†Ô∏è Debes seleccionar una ciudad de la lista de sugerencias.";
          }
        }, 300);
      });


      input.addEventListener('focus', function () {
        if (this.value.length >= 2) {
          const event = new Event('input');
          this.dispatchEvent(event);
        }
      });
    }

    setupCityAutocomplete("ciudad", "suggestions-ciudad", "provincia", "pais", "lat", "lon", "warning-ciudad");
    setupCityAutocomplete("ciudad_resi", "suggestions-resi", "provincia_resi", "pais_resi", "lat_resi", "lon_resi", "warning-resi");

    const MAKE_SAVE_URL   = "https://hook.us2.make.com/9mk1me5mskzfc4fj8neulfc2g4hbyrij"; // Escenario 1: guarda datos
    const MAKE_UPLOAD_URL = "https://hook.us2.make.com/bnafik2pdvulpn8gh4zbjejxojh9e2as";
    const FORM_SECRET     = "9438e981-9990-4d45-8839-ed6158341cd6";           // genera el tuyo (ver arriba)
      
    

    function fetchConTimeout(url, options = {}, ms = 20000) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), ms);
    
      // Nunca pises un signal que te pasen desde afuera
      const opts = { ...options, signal: options.signal ?? ctrl.signal };
    
      return fetch(url, opts)
        .finally(() => clearTimeout(id))
        .catch((err) => {
          // Decoramos el error para que quede claro qu√© pas√≥
          if (err.name === "AbortError") {
            throw new Error(`Timeout (${ms}ms) llamando a ${url}`);
          }
          throw err;
        });
    }    

    // Helper: parseo seguro
    async function safeJson(res) {
      try { return await res.json(); } catch { return {}; }
    }

    document.getElementById("cosmicForm").addEventListener("submit", async function (e) {
      e.preventDefault();

  /////////

    const btn=document.getElementById('btnEnviar');
    btn.disabled=true;btn.textContent='Enviando...';

  // Validacion si se selecciono ciudad de la lista y lat y lon tienen valor
    if (!document.getElementById('lat').value || !document.getElementById('lon').value) {
    alert("Debes seleccionar una ciudad de la lista para nacimiento.");
    btn.disabled = false;
    btn.textContent = 'Enviar';
    return;
  }



    function safeSlug(str) {
      return str
        .normalize('NFD')                 // separa tildes
        .replace(/[\u0300-\u036f]/g, '')  // quita tildes
        .replace(/√±/gi, 'n')              // √± -> n
        .replace(/[^a-zA-Z0-9._-]+/g, '_')// resto a _
        .replace(/^_+|_+$/g, '')          // bordes
        .toLowerCase();
    }

    const id_get = `${safeSlug(this.apellido.value)}_${this.fecha_nac.value}_${this.hora_nac.value}`;


    const fotoFile=document.getElementById('foto').files[0];
    const data={
      nombre:this.nombre.value,
      apellido:this.apellido.value,
      nombrecc:this.nombrecc.value,
      fecha_nac:this.fecha_nac.value,
      hora_nac:this.hora_nac.value,
      ciudad:this.ciudad.value,
      provincia:this.provincia.value,
      pais:this.pais.value,
      lat:document.getElementById('lat').value,
      lon:document.getElementById('lon').value,
      ciudad_resi:this.ciudad_resi.value,
      provincia_resi:this.provincia_resi.value,
      pais_resi:this.pais_resi.value,
      email: this.email.value,
      telefono: this.telefono.value,
      talento: this.talento.value,
      acceso: document.getElementById('acceso').value,
      colaborador:document.getElementById('nombreColaborador').value,
      id_get: id_get, // ID √∫nico para el registro
    };

    try{

      const url = `${MAKE_SAVE_URL}?x_form_secret=${encodeURIComponent(FORM_SECRET)}`;
      const res = await fetchConTimeout(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
             
          },
          body: JSON.stringify(data),
        });

      if (!res.ok) {
         const txt = await res.text();
         throw new Error(`Error al guardar (HTTP ${res.status}): ${txt}`);
      }

      const result = await safeJson(res);

      if (result?.error === "duplicado") {
       document.getElementById("mensaje-error")?.style?.setProperty("display","block");
       return;
      }

      if (!(result?.estado === "ok" && result?.id)) {
       throw new Error("Respuesta inesperada del primer escenario Make.");
      }


      if (result.estado === "ok" && result.id) {

          // 2) Si hay foto ‚Üí segundo request a Make (multipart/form-data)
        if (fotoFile && fotoFile.size > 0) {
          if (fotoFile.size > 700 * 1024) {
            alert("La imagen supera los 700KB.");
            return;
          }

          
          const base = `${data.nombre}_${data.apellido}`;
          const filename = `${safeSlug(base)}_${Date.now()}.jpg`;
          
          const fd = new FormData();
          fd.append("id", result.id);                 // id devuelto por Escenario 1
          fd.append("form_origen", "nh");             // o "nuevah"
          fd.append("filename", filename);
          fd.append("file", fotoFile, filename);      // <-- ac√° va el File real
          fd.append("x_form_secret", FORM_SECRET);

          // debug: ver que realmente se arma el FormData
          //for (const [k, v] of fd.entries()) {
          //  console.log(k, v instanceof File ? {name:v.name,size:v.size,type:v.type} : v);
          //}
          
          
          //console.log("Enviando a Make:", url);
          //console.log("FormData contenido:");
          const up = await fetchConTimeout(`${MAKE_UPLOAD_URL}?x_form_secret=${encodeURIComponent(FORM_SECRET)}`,
            { method: "POST", body: fd },
            60000
        );

                  

          const responseText = await up.text();
          //console.log("Respuesta Make:", up.status, responseText);

          if (!up.ok) {
            const txt = await up.text();
            throw new Error(`Error al subir foto (HTTP ${up.status}): ${txt}`);
          }
          
        }
          
          
        // ‚úÖ √âxito total
        document.getElementById("mensaje-exito")?.style?.setProperty("display","block");
        setTimeout(() => {
          document.getElementById("mensaje-exito")?.style?.setProperty("display","none");
        }, 5000);
      //  document.getElementById("mensaje-exito").style.display = "block";
      //  setTimeout(() => {
      //    document.getElementById("mensaje-exito").style.display = "none";
      //  }, 5000);
        this.reset();
      } else {
        alert("Hubo un problema al guardar el formulario.");
      }
//    } else {
//      throw new Error('Error en el env√≠o');
//    }
  } catch (error) {
    console.error('Error:', error);
    alert("Error al procesar el formulario.");
  } finally {
    btn.disabled = false;
    btn.textContent = 'Enviar';
  }
 
});
</script>
  
 
</body>

</html>
